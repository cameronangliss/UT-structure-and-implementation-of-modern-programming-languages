LINK
PUSHOFF -2

// string -> len
LINK
PUSHIMM 0
LOOP1:
    DUP
    PUSHOFF -1
    ADD
    PUSHIND
    ISNIL
    JUMPC DONE1
    PUSHIMM 1
    ADD
    JUMP LOOP1
DONE1:
    STOREOFF -1
    UNLINK

PUSHOFF -1

// string -> len
LINK
PUSHIMM 0
LOOP2:
    DUP
    PUSHOFF -1
    ADD
    PUSHIND
    ISNIL
    JUMPC DONE2
    PUSHIMM 1
    ADD
    JUMP LOOP2
DONE2:
    STOREOFF -1
    UNLINK

ADD
PUSHIMM 1
ADD
MALLOC
PUSHIMM 0
PUSHOFF -2

// write string to allocated space
LINK
LOOP3:
    PUSHOFF -1
    PUSHOFF -2
    ADD
    PUSHIND
    DUP
    ISNIL
    JUMPC DONE3
    PUSHOFF -3
    PUSHOFF -2
    ADD
    SWAP
    STOREIND
    PUSHOFF -2
    PUSHIMM 1
    ADD
    STOREOFF -2
    JUMP LOOP3
DONE3:
    ADDSP -1
    UNLINK

ADDSP -1
PUSHIMM 0
PUSHOFF -1

// write string to allocated space
LINK
LOOP4:
    PUSHOFF -1
    PUSHOFF -2
    ADD
    PUSHIND
    DUP
    ISNIL
    JUMPC DONE4
    PUSHOFF -4
    PUSHOFF -3
    PUSHOFF -2
    ADD
    ADD
    SWAP
    STOREIND
    PUSHOFF -2
    PUSHIMM 1
    ADD
    STOREOFF -2
    JUMP LOOP4
DONE4:
    ADDSP -1
    UNLINK

// clean-up
PUSHOFF 1
PUSHOFF 2
PUSHOFF 3
ADD
ADD
PUSHIMMCH '\0'
STOREIND
ADDSP -3
STOREOFF -2
UNLINK
ADDSP -1
